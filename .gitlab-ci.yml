stages:
  - build


rust-nightly:
  stage: build
  image: rustlang/rust:nightly
  services:
      - postgres:latest
  variables:
     GIT_SUBMODULE_STRATEGY: recursive

  before_script:
      # search and replace localhost to postgresl in .rs files in this project
      - find . -name '*.rs' -type f -exec sed -i 's/localhost/postgres/g' {} +
      - cd crates/rustorm
      - ./install-postgresql-client.sh
      - ./rename-database-host.sh
      - ./execute-data-import.sh
      - cd -

  script:
      - cargo test -p rustorm --all-features
      - cargo test -p diwata_intel
      - cargo test -p diwata_server
      - cargo test -p dataview
